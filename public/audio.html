<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoulTalk V2 - èªéŸ³æ¨¡å¼</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans TC', -apple-system, sans-serif; background: #f5f5f5; min-height: 100vh; }
        
        .navbar { background: linear-gradient(135deg, #2196f3, #00bcd4); color: #fff; padding: 15px 20px; display: flex; align-items: center; gap: 20px; }
        .navbar h1 { font-size: 1.3rem; flex: 1; }
        .navbar a { color: rgba(255,255,255,0.9); text-decoration: none; padding: 8px 16px; border-radius: 8px; }
        .navbar a:hover { background: rgba(255,255,255,0.2); }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .main-layout { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
        @media (max-width: 900px) { .main-layout { grid-template-columns: 1fr; } }
        
        .card { background: #fff; border-radius: 15px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        
        .input-section { display: flex; gap: 10px; margin-bottom: 15px; }
        .input-section input { flex: 1; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem; }
        .input-section input:focus { border-color: #2196f3; outline: none; }
        
        .btn { padding: 15px 25px; border: none; border-radius: 10px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #2196f3, #00bcd4); color: #fff; }
        .btn-primary:hover { transform: scale(1.02); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-success { background: #4caf50; color: #fff; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        
        /* 1:1 é è¦½ */
        .preview-container { position: relative; width: 100%; padding-top: 100%; background: #1a1a2e; border-radius: 15px; overflow: hidden; }
        .preview-inner { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
        .preview-cover { position: absolute; top: 0; left: 0; right: 0; bottom: 0; object-fit: cover; opacity: 0.4; }
        
        .preview-title { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #fff; z-index: 10; text-shadow: 0 2px 10px rgba(0,0,0,0.5); transition: opacity 1s; }
        .preview-title h2 { font-size: 28px; margin-bottom: 10px; }
        .preview-title p { font-size: 18px; opacity: 0.9; }
        
        .preview-subtitle { position: absolute; bottom: 50px; left: 20px; right: 20px; text-align: center; color: #fff; font-size: 22px; font-weight: 500; z-index: 10; text-shadow: 0 2px 8px rgba(0,0,0,0.7); line-height: 1.6; transition: opacity 1s; }
        
        /* å°ˆå±¬çµå°¾ - ç½®ä¸­æ·¡å…¥æ·¡å‡º */
        .preview-ending { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #fff; z-index: 20; opacity: 0; text-shadow: 0 2px 15px rgba(0,0,0,0.8); pointer-events: none; }
        .preview-ending.fade-in { animation: fadeIn var(--fade-in, 1.5s) ease-in forwards; }
        .preview-ending.fade-out { animation: fadeOut var(--fade-out, 2s) ease-out forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        
        .status-bar { background: #fafafa; border-radius: 10px; padding: 15px; margin: 15px 0; }
        .status-bar.loading { background: #e3f2fd; border-left: 4px solid #2196f3; }
        .status-bar.success { background: #e8f5e9; border-left: 4px solid #4caf50; }
        .status-bar.error { background: #ffebee; border-left: 4px solid #f44336; }
        
        .progress-bar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-top: 10px; display: none; }
        .progress-fill { height: 100%; background: linear-gradient(135deg, #2196f3, #00bcd4); transition: width 0.3s; }
        
        .data-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .data-item { background: #fafafa; padding: 12px; border-radius: 8px; }
        .data-item label { font-size: 0.85rem; color: #666; display: block; margin-bottom: 5px; }
        .data-item .value { font-weight: 500; }
        
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        .action-buttons .btn { flex: 1; min-width: 100px; }
        
        .transcript-preview { max-height: 200px; overflow-y: auto; background: #fafafa; padding: 15px; border-radius: 10px; font-size: 0.9rem; line-height: 1.8; white-space: pre-wrap; }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>ğŸ¤ èªéŸ³æ¨¡å¼</h1>
        <a href="/">ğŸ  é¦–é </a>
        <a href="/mv">ğŸ¬ MV</a>
        <a href="/settings">âš™ï¸ è¨­å®š</a>
    </nav>
    
    <div class="container">
        <div class="main-layout">
            <div class="left-column">
                <div class="card">
                    <div class="card-title">ğŸ“¥ è¼‰å…¥è³‡æ–™</div>
                    <div class="input-section">
                        <input type="text" id="ragicCode" placeholder="è¼¸å…¥ Ragic ä»£ç¢¼">
                        <button class="btn btn-primary" onclick="loadData()">è¼‰å…¥</button>
                    </div>
                    <div class="status-bar" id="statusBar">ğŸ’¡ èªéŸ³æ¨¡å¼ä½¿ç”¨å–®ä¸€å°é¢åœ–ï¼Œä¸éœ€è¦ MBTI é…è‰²</div>
                    <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
                </div>
                
                <div class="card">
                    <div class="card-title">ğŸ‘ï¸ é è¦½ï¼ˆ1:1 æ­£æ–¹å½¢ï¼‰</div>
                    <div class="preview-container">
                        <div class="preview-inner">
                            <img class="preview-cover" id="previewCover" src="" style="display: none;">
                            <div class="preview-title" id="previewTitle">
                                <h2 id="titleText">æ¨™é¡Œ</h2>
                                <p id="speakerText">æ¼”è¬›è€…</p>
                            </div>
                            <div class="preview-subtitle" id="previewSubtitle">å­—å¹•é¡¯ç¤ºå€åŸŸ</div>
                            <div class="preview-ending" id="previewEnding">
                                <div id="endingText"></div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="previewEnding()" style="margin-top: 15px; width: 100%;">ğŸ‘ï¸ é è¦½å°ˆå±¬çµå°¾æ•ˆæœ</button>
                </div>
                
                <div class="card" id="transcriptCard" style="display: none;">
                    <div class="card-title">ğŸ“ é€å­—ç¨¿</div>
                    <div class="transcript-preview" id="transcriptPreview"></div>
                </div>
            </div>
            
            <div class="right-column">
                <div class="card">
                    <div class="card-title">ğŸ‘¤ åŸºæœ¬è³‡æ–™</div>
                    <div class="data-grid">
                        <div class="data-item"><label>å§“å</label><div class="value" id="dataName">-</div></div>
                        <div class="data-item"><label>æ¨™é¡Œ</label><div class="value" id="dataTitle">-</div></div>
                    </div>
                </div>
                
                <div class="card" id="audioCard" style="display: none;">
                    <div class="card-title">ğŸµ éŸ³é »</div>
                    <audio id="audioPlayer" controls style="width: 100%;"></audio>
                </div>
                
                <div class="card">
                    <div class="card-title">ğŸš€ æ“ä½œ</div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="processBtn" onclick="startProcess()" disabled>âš¡ é–‹å§‹è™•ç†</button>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-success" id="uploadBtn" onclick="uploadJSON()" disabled>ğŸ“¤ ä¸Šå‚³</button>
                        <button class="btn btn-secondary" id="downloadBtn" onclick="downloadJSON()" disabled>ğŸ’¾ ä¸‹è¼‰</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentData = null, config = null, finalJSON = null;
        
        document.addEventListener('DOMContentLoaded', async () => {
            config = await (await fetch('/api/config')).json();
            
            const params = new URLSearchParams(window.location.search);
            if (params.get('code')) {
                document.getElementById('ragicCode').value = params.get('code');
                if (params.get('auto') === '1') loadData();
            }
            
            document.getElementById('ragicCode').addEventListener('keypress', e => { if (e.key === 'Enter') loadData(); });
            
            // è¨­å®šçµå°¾å‹•ç•«æ™‚é–“
            const endingConfig = config.customEnding || {};
            const endingEl = document.getElementById('previewEnding');
            endingEl.style.setProperty('--fade-in', (endingConfig.fadeInDuration || 1.5) + 's');
            endingEl.style.setProperty('--fade-out', (endingConfig.fadeOutDuration || 2) + 's');
        });
        
        async function loadData() {
            const code = document.getElementById('ragicCode').value.trim();
            if (!code) { showStatus('error', 'âŒ è«‹è¼¸å…¥ä»£ç¢¼'); return; }
            
            showStatus('loading', 'â³ è¼‰å…¥ä¸­...'); showProgress(20);
            
            try {
                const result = await (await fetch(`/api/audio/fetch/${encodeURIComponent(code)}`)).json();
                if (!result.success) throw new Error(result.error);
                
                currentData = result.data;
                showProgress(60); updateDisplay(); showProgress(100);
                
                showStatus(currentData.audioUrl ? 'success' : 'error', 
                    currentData.audioUrl ? 'âœ… è¼‰å…¥å®Œæˆï¼' : 'âš ï¸ ç¼ºå°‘éŸ³é »');
                document.getElementById('processBtn').disabled = !currentData.audioUrl;
                
            } catch (error) { showStatus('error', `âŒ ${error.message}`); }
        }
        
        function updateDisplay() {
            document.getElementById('dataName').textContent = currentData.name || '-';
            document.getElementById('dataTitle').textContent = currentData.title || '-';
            document.getElementById('titleText').textContent = currentData.title || 'æ¨™é¡Œ';
            document.getElementById('speakerText').textContent = currentData.speaker || currentData.name || '';
            
            if (currentData.coverImage) {
                const cover = document.getElementById('previewCover');
                cover.src = currentData.coverImage;
                cover.style.display = 'block';
            }
            
            if (currentData.audioUrl) {
                document.getElementById('audioCard').style.display = 'block';
                document.getElementById('audioPlayer').src = currentData.audioUrl;
            }
            
            if (currentData.transcript) {
                document.getElementById('transcriptCard').style.display = 'block';
                document.getElementById('transcriptPreview').textContent = currentData.transcript;
            }
            
            // è¨­å®šçµå°¾æ–‡å­—
            updateEndingText();
        }
        
        function updateEndingText() {
            const endingConfig = config.customEnding || {};
            if (endingConfig.enabled) {
                const text = (endingConfig.template || 'é€™æ˜¯å±¬æ–¼ {name} çš„å°ˆå±¬æ™‚åˆ»')
                    .replace('{name}', currentData?.name || 'ä½ ')
                    .replace('{mbti}', currentData?.mbti || '');
                const endingEl = document.getElementById('endingText');
                endingEl.textContent = text;
                endingEl.style.fontSize = (endingConfig.fontSize || 28) + 'px';
            }
        }
        
        // é è¦½å°ˆå±¬çµå°¾æ•ˆæœ
        function previewEnding() {
            const ending = document.getElementById('previewEnding');
            const title = document.getElementById('previewTitle');
            const subtitle = document.getElementById('previewSubtitle');
            const endingConfig = config.customEnding || {};
            
            // é‡ç½®ç‹€æ…‹
            ending.classList.remove('fade-in', 'fade-out');
            ending.style.opacity = '0';
            
            // æ·¡å‡ºå…¶ä»–å…ƒç´ 
            title.style.opacity = '0';
            subtitle.style.opacity = '0';
            
            // æ·¡å…¥çµå°¾ï¼ˆ1.5ç§’ï¼‰
            setTimeout(() => {
                ending.classList.add('fade-in');
            }, 300);
            
            // æŒçºŒé¡¯ç¤ºï¼Œç„¶å¾Œæ·¡å‡ºï¼ˆæœ€å¾Œ2ç§’æ·¡å‡ºï¼‰
            const duration = (endingConfig.duration || 8) * 1000;
            const fadeOutTime = (endingConfig.fadeOutDuration || 2) * 1000;
            
            setTimeout(() => {
                ending.classList.remove('fade-in');
                ending.classList.add('fade-out');
            }, duration - fadeOutTime);
            
            // æ¢å¾©å…¶ä»–å…ƒç´ 
            setTimeout(() => {
                ending.classList.remove('fade-out');
                ending.style.opacity = '0';
                title.style.opacity = '1';
                subtitle.style.opacity = '1';
            }, duration + 500);
        }
        
        async function startProcess() {
            showStatus('loading', 'âš¡ è™•ç†ä¸­...');
            document.getElementById('processBtn').disabled = true;
            
            for (let i = 1; i <= 20; i++) {
                await new Promise(r => setTimeout(r, 150));
                showProgress(i * 5);
            }
            
            finalJSON = generateJSON();
            showStatus('success', 'âœ… è™•ç†å®Œæˆï¼');
            document.getElementById('uploadBtn').disabled = false;
            document.getElementById('downloadBtn').disabled = false;
            
            // è‡ªå‹•é è¦½çµå°¾æ•ˆæœ
            setTimeout(previewEnding, 500);
        }
        
        function generateJSON() {
            const endingConfig = config.customEnding || {};
            
            return {
                version: '2.0.0',
                mode: 'audio',
                meta: {
                    title: currentData.title || '',
                    speaker: currentData.speaker || currentData.name || '',
                    ragicCode: currentData.ragicCode,
                    generatedAt: new Date().toISOString()
                },
                audio: { url: currentData.audioUrl },
                titleDisplay: {
                    title: currentData.title || '',
                    artist: currentData.speaker || currentData.name || '',
                    position: 'top'
                },
                coverImage: currentData.coverImage || '',
                // å°ˆå±¬çµå°¾è¨­å®š
                customEnding: endingConfig.enabled ? {
                    enabled: true,
                    text: (endingConfig.template || '')
                        .replace('{name}', currentData.name || '')
                        .replace('{mbti}', currentData.mbti || ''),
                    fontSize: endingConfig.fontSize || 28,
                    fontSizeMobile: endingConfig.fontSizeMobile || 20,
                    duration: endingConfig.duration || 8,
                    fadeInDuration: endingConfig.fadeInDuration || 1.5,
                    fadeOutDuration: endingConfig.fadeOutDuration || 2,
                    position: 'center'  // ä¸Šä¸‹å·¦å³ç½®ä¸­
                } : { enabled: false },
                subtitleStyles: config.subtitleStyles || {},
                transcriptTimeline: []
            };
        }
        
        async function uploadJSON() {
            if (!finalJSON) return;
            showStatus('loading', 'ğŸ“¤ ä¸Šå‚³ä¸­...');
            
            try {
                const result = await (await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        queryCode: document.getElementById('ragicCode').value.trim(),
                        mvCode: currentData.mvCode || '',
                        audioCode: currentData.audioCode || '',
                        mode: 'audio',
                        jsonData: finalJSON
                    })
                })).json();
                
                showStatus(result.success ? 'success' : 'error', result.success ? 'âœ… ä¸Šå‚³æˆåŠŸï¼' : `âŒ ${result.error}`);
            } catch (error) { showStatus('error', `âŒ ${error.message}`); }
        }
        
        function downloadJSON() {
            if (!finalJSON) return;
            const blob = new Blob([JSON.stringify(finalJSON, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `audio_${currentData.ragicCode || 'output'}.json`;
            a.click();
        }
        
        function showStatus(type, msg) {
            const bar = document.getElementById('statusBar');
            bar.className = 'status-bar ' + type;
            bar.textContent = msg;
        }
        
        function showProgress(pct) {
            const bar = document.getElementById('progressBar');
            const fill = document.getElementById('progressFill');
            bar.style.display = pct > 0 && pct < 100 ? 'block' : 'none';
            fill.style.width = pct + '%';
        }
    </script>
</body>
</html>
