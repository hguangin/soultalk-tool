<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoulTalk V2 - MV æ¨¡å¼</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Noto Sans TC', -apple-system, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        /* å°èˆª */
        .navbar {
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            color: #fff;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .navbar h1 { font-size: 1.3rem; flex: 1; }
        .navbar a {
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .navbar a:hover { background: rgba(255,255,255,0.2); }
        
        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* å…©æ¬„å¸ƒå±€ */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }
        
        @media (max-width: 1000px) {
            .main-layout { grid-template-columns: 1fr; }
        }
        
        /* å¡ç‰‡ */
        .card {
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* è¼¸å…¥å€ */
        .input-section {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .input-section input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
        }
        
        .input-section input:focus {
            border-color: #e91e63;
            outline: none;
        }
        
        /* æŒ‰éˆ• */
        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            color: #fff;
        }
        
        .btn-primary:hover { transform: scale(1.02); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-success { background: #4caf50; color: #fff; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        
        /* é è¦½å€ - 1:1 æ­£æ–¹å½¢ */
        .preview-container {
            position: relative;
            width: 100%;
            padding-top: 100%; /* 1:1 æ¯”ä¾‹ */
            background: #000;
            border-radius: 15px;
            overflow: hidden;
        }
        
        .preview-inner {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
        }
        
        /* æ˜Ÿå…‰èƒŒæ™¯ */
        .starry-bg {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%);
            overflow: hidden;
        }
        
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle var(--duration) ease-in-out infinite;
        }
        
        .star.bright {
            box-shadow: 0 0 3px 1px rgba(255, 255, 255, 0.6);
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        .shooting-star {
            position: absolute;
            width: 3px;
            height: 3px;
            background: white;
            border-radius: 50%;
            animation: shoot var(--duration) linear infinite;
            animation-delay: var(--delay);
        }
        
        .shooting-star::after {
            content: '';
            position: absolute;
            width: 80px;
            height: 1px;
            background: linear-gradient(to right, rgba(255,255,255,0.8), transparent);
            transform: rotate(45deg);
            transform-origin: left center;
            right: 0;
        }
        
        @keyframes shoot {
            0% { transform: translate(0, 0); opacity: 1; }
            70% { opacity: 1; }
            100% { transform: translate(-300px, 300px); opacity: 0; }
        }
        
        /* é è¦½å…§å®¹ */
        .preview-image {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            object-fit: cover;
            z-index: 2;
        }
        
        .preview-title {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #fff;
            z-index: 10;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        
        .preview-title h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .preview-title p {
            font-size: 18px;
            opacity: 0.9;
        }
        
        .preview-subtitle {
            position: absolute;
            bottom: 40px;
            left: 0; right: 0;
            text-align: center;
            color: #fff;
            font-size: 24px;
            font-weight: bold;
            z-index: 10;
            text-shadow: 0 2px 8px rgba(0,0,0,0.7);
        }
        
        /* å°ˆå±¬çµå°¾ */
        .preview-ending {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #fff;
            z-index: 10;
            opacity: 0;
            transition: opacity 2s;
        }
        
        .preview-ending.show {
            opacity: 1;
        }
        
        /* ç‹€æ…‹é¡¯ç¤º */
        .status-bar {
            background: #fafafa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .status-bar.loading { background: #e3f2fd; border-left: 4px solid #2196f3; }
        .status-bar.success { background: #e8f5e9; border-left: 4px solid #4caf50; }
        .status-bar.error { background: #ffebee; border-left: 4px solid #f44336; }
        
        /* é€²åº¦æ¢ */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            transition: width 0.3s;
        }
        
        /* è³‡æ–™é¡¯ç¤º */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .data-item {
            background: #fafafa;
            padding: 12px;
            border-radius: 8px;
        }
        
        .data-item label {
            font-size: 0.85rem;
            color: #666;
            display: block;
            margin-bottom: 5px;
        }
        
        .data-item .value {
            font-weight: 500;
            word-break: break-all;
        }
        
        .data-item .value.empty { color: #999; }
        
        /* MBTI æ¨™ç±¤ */
        .mbti-badge {
            display: inline-block;
            padding: 5px 12px;
            background: linear-gradient(135deg, #e91e63, #9c27b0);
            color: #fff;
            border-radius: 20px;
            font-weight: bold;
        }
        
        /* é¡è‰²é è¦½ */
        .color-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 5px 12px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        .color-swatch {
            width: 60px;
            height: 25px;
            border-radius: 5px;
        }
        
        /* åœ–ç‰‡åˆ—è¡¨ */
        .image-list {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .image-thumb {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .image-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-thumb .type {
            position: absolute;
            bottom: 0;
            left: 0; right: 0;
            background: rgba(0,0,0,0.7);
            color: #fff;
            font-size: 0.7rem;
            padding: 2px;
            text-align: center;
        }
        
        /* å‹•ä½œæŒ‰éˆ•å€ */
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .action-buttons .btn {
            flex: 1;
            min-width: 120px;
        }
        
        /* æ­Œè©é è¦½ */
        .lyrics-preview {
            max-height: 200px;
            overflow-y: auto;
            background: #fafafa;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            line-height: 1.8;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <!-- å°èˆª -->
    <nav class="navbar">
        <h1>ğŸ¬ MV æ¨¡å¼</h1>
        <a href="/">ğŸ  é¦–é </a>
        <a href="/audio">ğŸ¤ èªéŸ³</a>
        <a href="/settings">âš™ï¸ è¨­å®š</a>
    </nav>
    
    <div class="container">
        <div class="main-layout">
            <!-- å·¦æ¬„ï¼šä¸»è¦æ“ä½œå€ -->
            <div class="left-column">
                <!-- è¼¸å…¥å€ -->
                <div class="card">
                    <div class="card-title">ğŸ“¥ è¼‰å…¥è³‡æ–™</div>
                    <div class="input-section">
                        <input type="text" id="ragicCode" placeholder="è¼¸å…¥ Ragic ä»£ç¢¼ï¼ˆä¾‹å¦‚ï¼šHGTWï¼‰">
                        <button class="btn btn-primary" id="loadBtn" onclick="loadData()">è¼‰å…¥</button>
                    </div>
                    
                    <!-- ç‹€æ…‹ -->
                    <div class="status-bar" id="statusBar">
                        ğŸ’¡ è¼¸å…¥ä»£ç¢¼å¾Œé»æ“Šè¼‰å…¥ï¼Œç³»çµ±æœƒè‡ªå‹•é–‹å§‹è™•ç†
                    </div>
                    
                    <div class="progress-bar" id="progressBar" style="display: none;">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- é è¦½å€ -->
                <div class="card">
                    <div class="card-title">ğŸ‘ï¸ é è¦½ï¼ˆ1:1 æ­£æ–¹å½¢ï¼‰</div>
                    <div class="preview-container">
                        <div class="preview-inner">
                            <!-- æ˜Ÿå…‰èƒŒæ™¯ -->
                            <div class="starry-bg" id="starryBg">
                                <!-- å‹•æ…‹ç”Ÿæˆæ˜Ÿæ˜Ÿ -->
                            </div>
                            
                            <!-- åœ–ç‰‡ -->
                            <img class="preview-image" id="previewImage" src="" style="display: none;">
                            
                            <!-- æ¨™é¡Œ -->
                            <div class="preview-title" id="previewTitle">
                                <h2 id="titleText">æ­Œæ›²æ¨™é¡Œ</h2>
                                <p id="artistText">æ¼”å”±è€…</p>
                            </div>
                            
                            <!-- å­—å¹• -->
                            <div class="preview-subtitle" id="previewSubtitle"></div>
                            
                            <!-- å°ˆå±¬çµå°¾ -->
                            <div class="preview-ending" id="previewEnding">
                                <div id="endingText" style="font-size: 28px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æ­Œè© -->
                <div class="card" id="lyricsCard" style="display: none;">
                    <div class="card-title">ğŸ“ æ­Œè©</div>
                    <div class="lyrics-preview" id="lyricsPreview"></div>
                </div>
            </div>
            
            <!-- å³æ¬„ï¼šè³‡æ–™é¡¯ç¤º -->
            <div class="right-column">
                <!-- åŸºæœ¬è³‡æ–™ -->
                <div class="card">
                    <div class="card-title">ğŸ‘¤ åŸºæœ¬è³‡æ–™</div>
                    <div class="data-grid">
                        <div class="data-item">
                            <label>å§“å</label>
                            <div class="value" id="dataName">-</div>
                        </div>
                        <div class="data-item">
                            <label>æ€§åˆ¥</label>
                            <div class="value" id="dataGender">-</div>
                        </div>
                        <div class="data-item">
                            <label>MBTI</label>
                            <div class="value" id="dataMBTI">-</div>
                        </div>
                        <div class="data-item">
                            <label>åœ°å€</label>
                            <div class="value" id="dataRegion">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- é…è‰²è³‡è¨Š -->
                <div class="card" id="colorCard" style="display: none;">
                    <div class="card-title">ğŸ¨ MBTI é…è‰²</div>
                    <div class="data-item">
                        <label>é…è‰²çµ„</label>
                        <div class="value" id="colorGroupName">-</div>
                    </div>
                    <div class="color-badge" style="margin-top: 10px;">
                        <span>èƒŒæ™¯ï¼š</span>
                        <div class="color-swatch" id="colorSwatch"></div>
                    </div>
                    <div class="data-item" style="margin-top: 10px;">
                        <label>è¦–è¦ºåƒæ•¸</label>
                        <div class="value" id="visualParams">-</div>
                    </div>
                </div>
                
                <!-- åœ–ç‰‡ -->
                <div class="card" id="imageCard" style="display: none;">
                    <div class="card-title">ğŸ–¼ï¸ åœ–ç‰‡ (<span id="imageCount">0</span> å¼µ)</div>
                    <div class="image-list" id="imageList"></div>
                </div>
                
                <!-- éŸ³é »è³‡è¨Š -->
                <div class="card" id="audioCard" style="display: none;">
                    <div class="card-title">ğŸµ éŸ³é »è³‡è¨Š</div>
                    <div class="data-grid">
                        <div class="data-item" style="grid-column: span 2;">
                            <label>æ­Œæ›²</label>
                            <div class="value" id="dataSongTitle">-</div>
                        </div>
                        <div class="data-item" style="grid-column: span 2;">
                            <label>æ¼”å”±è€…</label>
                            <div class="value" id="dataArtist">-</div>
                        </div>
                    </div>
                    <audio id="audioPlayer" controls style="width: 100%; margin-top: 10px;"></audio>
                </div>
                
                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="card">
                    <div class="card-title">ğŸš€ æ“ä½œ</div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="transcribeBtn" onclick="startTranscription()" disabled>
                            ğŸ¤ èªéŸ³è­˜åˆ¥
                        </button>
                        <button class="btn btn-primary" id="matchBtn" onclick="startMatching()" disabled>
                            ğŸ¤– AI åŒ¹é…
                        </button>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-success" id="uploadBtn" onclick="uploadJSON()" disabled>
                            ğŸ“¤ ä¸Šå‚³
                        </button>
                        <button class="btn btn-secondary" id="downloadBtn" onclick="downloadJSON()" disabled>
                            ğŸ’¾ ä¸‹è¼‰ JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ========================================
        // å…¨åŸŸè®Šæ•¸
        // ========================================
        let currentData = null;
        let config = null;
        let transcriptionResult = null;
        let finalJSON = null;
        
        // ========================================
        // åˆå§‹åŒ–
        // ========================================
        document.addEventListener('DOMContentLoaded', async () => {
            // è¼‰å…¥è¨­å®š
            const configResponse = await fetch('/api/config');
            config = await configResponse.json();
            
            // ç”Ÿæˆæ˜Ÿç©ºèƒŒæ™¯
            generateStars(60);
            
            // æª¢æŸ¥ URL åƒæ•¸
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const auto = params.get('auto');
            
            if (code) {
                document.getElementById('ragicCode').value = code;
                if (auto === '1') {
                    loadData();
                }
            }
            
            // Enter éµ
            document.getElementById('ragicCode').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loadData();
            });
        });
        
        // ========================================
        // æ˜Ÿç©ºèƒŒæ™¯
        // ========================================
        function generateStars(count) {
            const container = document.getElementById('starryBg');
            container.innerHTML = '';
            
            // æ˜Ÿæ˜Ÿ
            for (let i = 0; i < count; i++) {
                const star = document.createElement('div');
                star.className = 'star' + (Math.random() < 0.1 ? ' bright' : '');
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = (Math.random() * 2 + 0.5) + 'px';
                star.style.height = star.style.width;
                star.style.setProperty('--duration', (Math.random() * 3 + 2) + 's');
                container.appendChild(star);
            }
            
            // æµæ˜Ÿ
            for (let i = 0; i < 3; i++) {
                const shootingStar = document.createElement('div');
                shootingStar.className = 'shooting-star';
                shootingStar.style.left = (Math.random() * 50 + 30) + '%';
                shootingStar.style.top = (Math.random() * 30 + 10) + '%';
                shootingStar.style.setProperty('--duration', (Math.random() * 2 + 1) + 's');
                shootingStar.style.setProperty('--delay', (Math.random() * 10 + 5) + 's');
                container.appendChild(shootingStar);
            }
        }
        
        // æ›´æ–°æ˜Ÿç©ºï¼ˆæ ¹æ“š MBTIï¼‰
        function updateStars(starCount, shootingCount) {
            const container = document.getElementById('starryBg');
            container.innerHTML = '';
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star' + (Math.random() < 0.1 ? ' bright' : '');
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = (Math.random() * 2 + 0.5) + 'px';
                star.style.height = star.style.width;
                star.style.setProperty('--duration', (Math.random() * 3 + 2) + 's');
                container.appendChild(star);
            }
            
            for (let i = 0; i < shootingCount; i++) {
                const shootingStar = document.createElement('div');
                shootingStar.className = 'shooting-star';
                shootingStar.style.left = (Math.random() * 50 + 30) + '%';
                shootingStar.style.top = (Math.random() * 30 + 10) + '%';
                shootingStar.style.setProperty('--duration', (Math.random() * 2 + 1) + 's');
                shootingStar.style.setProperty('--delay', (Math.random() * 10 + i * 3) + 's');
                container.appendChild(shootingStar);
            }
        }
        
        // ========================================
        // è¼‰å…¥è³‡æ–™
        // ========================================
        async function loadData() {
            const code = document.getElementById('ragicCode').value.trim();
            if (!code) {
                showStatus('error', 'âŒ è«‹è¼¸å…¥ Ragic ä»£ç¢¼');
                return;
            }
            
            showStatus('loading', 'â³ æ­£åœ¨è¼‰å…¥è³‡æ–™...');
            showProgress(10);
            
            try {
                const response = await fetch(`/api/mv/fetch/${encodeURIComponent(code)}`);
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'è¼‰å…¥å¤±æ•—');
                }
                
                currentData = result.data;
                showProgress(50);
                
                // æ›´æ–°é¡¯ç¤º
                updateDataDisplay();
                showProgress(80);
                
                // æ›´æ–°é è¦½
                updatePreview();
                showProgress(100);
                
                // æª¢æŸ¥æ˜¯å¦å¯ä»¥è‡ªå‹•é–‹å§‹
                const missingFields = [];
                if (!currentData.audioUrl) missingFields.push('éŸ³é »é€£çµ');
                if (!currentData.lyrics) missingFields.push('æ­Œè©');
                
                if (missingFields.length === 0) {
                    showStatus('success', 'âœ… è³‡æ–™è¼‰å…¥å®Œæˆï¼æ­£åœ¨è‡ªå‹•é–‹å§‹èªéŸ³è­˜åˆ¥...');
                    document.getElementById('transcribeBtn').disabled = false;
                    
                    // è‡ªå‹•é–‹å§‹
                    setTimeout(() => startTranscription(), 1000);
                } else {
                    showStatus('error', `âš ï¸ ç¼ºå°‘å¿…è¦è³‡æ–™: ${missingFields.join(', ')}`);
                }
                
            } catch (error) {
                showStatus('error', `âŒ è¼‰å…¥å¤±æ•—: ${error.message}`);
                showProgress(0);
            }
        }
        
        // ========================================
        // æ›´æ–°è³‡æ–™é¡¯ç¤º
        // ========================================
        function updateDataDisplay() {
            // åŸºæœ¬è³‡æ–™
            document.getElementById('dataName').textContent = currentData.name || '-';
            document.getElementById('dataGender').textContent = currentData.gender || '-';
            document.getElementById('dataRegion').textContent = currentData.region || '-';
            
            // MBTI
            const mbtiEl = document.getElementById('dataMBTI');
            if (currentData.mbti) {
                mbtiEl.innerHTML = `<span class="mbti-badge">${currentData.mbti}</span>`;
            } else {
                mbtiEl.textContent = '-';
            }
            
            // é…è‰²
            if (currentData.bgColors) {
                document.getElementById('colorCard').style.display = 'block';
                document.getElementById('colorGroupName').textContent = currentData.colorGroupName || 'è‡ªå‹•é…è‰²';
                
                const swatch = document.getElementById('colorSwatch');
                const direction = currentData.bgDirection || 'to-bottom-right';
                const dirMap = {
                    'to-bottom': '180deg',
                    'to-right': '90deg',
                    'to-bottom-right': '135deg',
                    'to-bottom-left': '225deg',
                    'radial': '135deg'
                };
                swatch.style.background = `linear-gradient(${dirMap[direction]}, ${currentData.bgColors.join(', ')})`;
                
                // è¦–è¦ºåƒæ•¸
                if (currentData.visualParams) {
                    document.getElementById('visualParams').textContent = 
                        `æ˜Ÿæ˜Ÿ: ${currentData.visualParams.starCount} / æµæ˜Ÿ: ${currentData.visualParams.shootingCount}`;
                    
                    // æ›´æ–°æ˜Ÿç©º
                    updateStars(currentData.visualParams.starCount, currentData.visualParams.shootingCount);
                }
            }
            
            // åœ–ç‰‡
            if (currentData.images && currentData.images.all.length > 0) {
                document.getElementById('imageCard').style.display = 'block';
                document.getElementById('imageCount').textContent = currentData.images.all.length;
                
                const imageList = document.getElementById('imageList');
                imageList.innerHTML = currentData.images.all.map(img => `
                    <div class="image-thumb">
                        <img src="${img.url}" alt="${img.title || ''}">
                        <div class="type">${img.type}</div>
                    </div>
                `).join('');
            }
            
            // éŸ³é »
            if (currentData.audioUrl) {
                document.getElementById('audioCard').style.display = 'block';
                document.getElementById('dataSongTitle').textContent = currentData.songTitle || '-';
                document.getElementById('dataArtist').textContent = currentData.artist || '-';
                document.getElementById('audioPlayer').src = currentData.audioUrl;
            }
            
            // æ­Œè©
            if (currentData.lyrics) {
                document.getElementById('lyricsCard').style.display = 'block';
                document.getElementById('lyricsPreview').textContent = currentData.lyrics;
            }
        }
        
        // ========================================
        // æ›´æ–°é è¦½
        // ========================================
        function updatePreview() {
            // æ¨™é¡Œ
            document.getElementById('titleText').textContent = currentData.songTitle || 'æ­Œæ›²æ¨™é¡Œ';
            document.getElementById('artistText').textContent = currentData.artist || currentData.name || 'æ¼”å”±è€…';
            
            // èƒŒæ™¯é¡è‰²
            if (currentData.bgColors) {
                const starryBg = document.getElementById('starryBg');
                const direction = currentData.bgDirection || 'to-bottom-right';
                
                if (direction === 'radial') {
                    starryBg.style.background = `radial-gradient(ellipse at center, ${currentData.bgColors[0]} 0%, ${currentData.bgColors[1]} 50%, ${currentData.bgColors[2]} 100%)`;
                } else {
                    const dirMap = {
                        'to-bottom': 'to bottom',
                        'to-right': 'to right',
                        'to-bottom-right': '135deg',
                        'to-bottom-left': '225deg'
                    };
                    starryBg.style.background = `linear-gradient(${dirMap[direction]}, ${currentData.bgColors[0]} 0%, ${currentData.bgColors[1]} 50%, ${currentData.bgColors[2]} 100%)`;
                }
            }
            
            // é¡¯ç¤ºç¬¬ä¸€å¼µåœ–ç‰‡
            if (currentData.images && currentData.images.all.length > 0) {
                const img = document.getElementById('previewImage');
                img.src = currentData.images.all[0].url;
                img.style.display = 'block';
                img.style.opacity = '0.3';
            }
            
            // å°ˆå±¬çµå°¾é è¦½ï¼ˆç¤ºæ„ï¼‰
            const endingConfig = config.customEnding || {};
            if (endingConfig.enabled) {
                const template = endingConfig.template || 'é€™æ˜¯å±¬æ–¼ {name} çš„ {mbti} å°ˆå±¬æ™‚åˆ»';
                const text = template
                    .replace('{name}', currentData.name || 'ä½ ')
                    .replace('{mbti}', currentData.mbti || 'MBTI');
                document.getElementById('endingText').textContent = text;
                document.getElementById('endingText').style.fontSize = (endingConfig.fontSize || 28) + 'px';
            }
        }
        
        // ========================================
        // èªéŸ³è­˜åˆ¥ï¼ˆæ¨¡æ“¬ï¼‰
        // ========================================
        async function startTranscription() {
            showStatus('loading', 'ğŸ¤ æ­£åœ¨é€²è¡ŒèªéŸ³è­˜åˆ¥...');
            document.getElementById('transcribeBtn').disabled = true;
            
            // æ¨¡æ“¬è™•ç†
            await simulateProgress(3000);
            
            // æ¨¡æ“¬çµæœ
            transcriptionResult = {
                text: currentData.lyrics,
                segments: []
            };
            
            showStatus('success', 'âœ… èªéŸ³è­˜åˆ¥å®Œæˆï¼æ­£åœ¨è‡ªå‹•é€²è¡Œ AI åŒ¹é…...');
            document.getElementById('matchBtn').disabled = false;
            
            // è‡ªå‹•é–‹å§‹åŒ¹é…
            setTimeout(() => startMatching(), 500);
        }
        
        // ========================================
        // AI åŒ¹é…ï¼ˆæ¨¡æ“¬ï¼‰
        // ========================================
        async function startMatching() {
            showStatus('loading', 'ğŸ¤– æ­£åœ¨é€²è¡Œ AI åŒ¹é…...');
            document.getElementById('matchBtn').disabled = true;
            
            // æ¨¡æ“¬è™•ç†
            await simulateProgress(4000);
            
            // ç”Ÿæˆ JSON
            finalJSON = generateFinalJSON();
            
            showStatus('success', 'âœ… è™•ç†å®Œæˆï¼å¯ä»¥ä¸Šå‚³æˆ–ä¸‹è¼‰ JSON');
            document.getElementById('uploadBtn').disabled = false;
            document.getElementById('downloadBtn').disabled = false;
            
            // é¡¯ç¤ºå°ˆå±¬çµå°¾é è¦½
            showEndingPreview();
        }
        
        // ========================================
        // ç”Ÿæˆæœ€çµ‚ JSON
        // ========================================
        function generateFinalJSON() {
            const endingConfig = config.customEnding || {};
            
            return {
                version: '2.0.0',
                mode: 'mv',
                meta: {
                    version: '2.0.0',
                    title: currentData.songTitle || '',
                    artist: currentData.artist || currentData.name || '',
                    duration: 180, // å¾…è¨ˆç®—
                    shareCode: generateShareCode(),
                    ragicCode: currentData.ragicCode,
                    generatedAt: new Date().toISOString()
                },
                audio: {
                    url: currentData.audioUrl,
                    format: 'mp3',
                    preload: 'metadata'
                },
                titleDisplay: {
                    title: currentData.songTitle || '',
                    artist: currentData.artist || currentData.name || '',
                    persistent: false,
                    position: 'center',
                    fadeOutAfter: 12
                },
                visualConfig: {
                    enableStarryBg: true,
                    starryBgOnAllSlides: true,
                    stars: {
                        count: currentData.visualParams?.starCount || 60
                    },
                    shootingStars: {
                        enabled: true,
                        count: currentData.visualParams?.shootingCount || 3
                    },
                    bgGradient: currentData.bgColors || ['#1a1a2e', '#16213e', '#0f3460'],
                    bgDirection: currentData.bgDirection || 'to-bottom-right'
                },
                // å°ˆå±¬çµå°¾
                customEnding: endingConfig.enabled ? {
                    enabled: true,
                    text: (endingConfig.template || '')
                        .replace('{name}', currentData.name || '')
                        .replace('{mbti}', currentData.mbti || ''),
                    fontSize: endingConfig.fontSize || 28,
                    fontSizeMobile: endingConfig.fontSizeMobile || 20,
                    duration: endingConfig.duration || 8,
                    fadeInDuration: endingConfig.fadeInDuration || 1.5,
                    fadeOutDuration: endingConfig.fadeOutDuration || 2
                } : { enabled: false },
                subtitleStyles: config.subtitleStyles || {},
                imageTimeline: [],
                lyricsTimeline: []
            };
        }
        
        function generateShareCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        // ========================================
        // é¡¯ç¤ºå°ˆå±¬çµå°¾é è¦½
        // ========================================
        function showEndingPreview() {
            const ending = document.getElementById('previewEnding');
            const title = document.getElementById('previewTitle');
            const subtitle = document.getElementById('previewSubtitle');
            
            // éš±è—å…¶ä»–å…ƒç´ 
            title.style.opacity = '0';
            subtitle.style.opacity = '0';
            
            // é¡¯ç¤ºçµå°¾
            ending.classList.add('show');
            
            // 3ç§’å¾Œæ¢å¾©
            setTimeout(() => {
                ending.classList.remove('show');
                title.style.opacity = '1';
            }, 3000);
        }
        
        // ========================================
        // ä¸Šå‚³
        // ========================================
        async function uploadJSON() {
            if (!finalJSON) {
                showStatus('error', 'âŒ æ²’æœ‰ JSON è³‡æ–™');
                return;
            }
            
            showStatus('loading', 'ğŸ“¤ æ­£åœ¨ä¸Šå‚³...');
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        queryCode: document.getElementById('ragicCode').value.trim(),
                        mvCode: currentData.mvCode || '',
                        audioCode: currentData.audioCode || '',
                        mode: 'mv',
                        jsonData: finalJSON
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('success', 'âœ… ä¸Šå‚³æˆåŠŸï¼');
                } else {
                    throw new Error(result.error || 'ä¸Šå‚³å¤±æ•—');
                }
                
            } catch (error) {
                showStatus('error', `âŒ ä¸Šå‚³å¤±æ•—: ${error.message}`);
            }
        }
        
        // ========================================
        // ä¸‹è¼‰
        // ========================================
        function downloadJSON() {
            if (!finalJSON) {
                showStatus('error', 'âŒ æ²’æœ‰ JSON è³‡æ–™');
                return;
            }
            
            const blob = new Blob([JSON.stringify(finalJSON, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mv_${currentData.ragicCode || 'output'}_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('success', 'âœ… JSON å·²ä¸‹è¼‰');
        }
        
        // ========================================
        // å·¥å…·å‡½æ•¸
        // ========================================
        function showStatus(type, message) {
            const bar = document.getElementById('statusBar');
            bar.className = 'status-bar ' + type;
            bar.textContent = message;
        }
        
        function showProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            const fill = document.getElementById('progressFill');
            
            if (percent > 0 && percent < 100) {
                progressBar.style.display = 'block';
                fill.style.width = percent + '%';
            } else if (percent >= 100) {
                fill.style.width = '100%';
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    fill.style.width = '0%';
                }, 500);
            } else {
                progressBar.style.display = 'none';
            }
        }
        
        async function simulateProgress(duration) {
            const steps = 20;
            const stepDuration = duration / steps;
            
            for (let i = 1; i <= steps; i++) {
                await new Promise(r => setTimeout(r, stepDuration));
                showProgress((i / steps) * 100);
            }
        }
    </script>
</body>
</html>
